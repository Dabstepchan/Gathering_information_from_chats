# Gathering information from chats
Бот для сбора отчетов из чатов. Проверяет наличие сообщений с заданными хештегами за указанный период. Отправляет отчеты в личные сообщения, сохраняет в Google-таблицу.
## Требования
- **Docker** — платформа для разработки, доставки и запуска контейнерных приложений;
- **PHP 8.1** — язык программирования;
- **Laravel 10.48.28** — PHP-фреймворк;
- **Nginx 1.29** — веб-сервер;
- **MySQL 8.2** — база данных.
## Создание Telegram-бота:
1. Перейдите в Telegram и найдите бота [@BotFather](https://t.me/BotFather);
2. Используя команды BotFather, создайте нового бота:
   - `/newbot` — укажите имя для бота;
   - Сохраните API-ключ, который выдает BotFather;
   - Созданного бота добавьте во все необходимые чаты.
## Настройка Google Sheets API:
1. Перейдите на [Google Cloud Console](https://console.cloud.google.com/);
2. Создайте новый проект;
3. Активируйте API Google Sheets;
4. Создайте **Service Account**:
   - Перейдите в раздел **Credentials**.
   - Нажмите **Create Credentials → Service Account**.
   - Укажите имя, создайте, и на вкладке ключей добавьте новый ключ в формате JSON.
   - Скачайте файл ключа.
5. В проекте:
   - Используйте значения ключа в `.env` файле. Названия полей в `.json` файле соответствуют полям в `.env`, но с добавлением в начале слова GOOGLE, к примеру, GOOGLE_CLIENT_EMAIL.
## Настройка проекта:
1. Переименуйте файл `.env.example` в `.env`;
2. Сгенерируйте ключ приложения командой: `php artisan key:generate`;
3. Введите свои данные в env:
- **GOOGLE_APPLICATION_NAME** — название таблицы;
- **GOOGLE_SHEET_ID** — ID листа;
- **GOOGLE_CLIENT_ID** — ID клиента (с Google Sheets API);
- **GOOGLE_PRIVATE_KEY_ID** — ключ из `.json` файла;
- **GOOGLE_PRIVATE_KEY**;
- **GOOGLE_CLIENT_EMAIL**;
- **TELEGRAM_ADMIN_USER_ID** — ID пользователя Telegram, которому будут приходить отчёты;
## Настройка Google таблицы:
1. Создайте таблицу Google Sheets;
2. Добавьте в качестве редактора email сервисного аккаунта.
## Запуск сервера:
1. Запустите Docker контейнеры.
## Настройка БД:
1. Создайте базу данных, по необходимости измените `.env`;
2. Выполните миграции для создания таблиц командой: `php artisan migrate`;
3. Согласно инструкциям Telegraph, внесите бота в таблицу командой: `php artisan telegraph:new-bot`;
4. Введите ключ из [@BotFather](https://t.me/BotFather), затем имя бота, добавляем чат к боту (первым чатом добавьте пользователя, который будет получать отчеты, для это введите свой Telegram ID), сделайте вебхук;
5. При необходимости: добавьте все необходимые чаты через следующую команду: `php artisan telegraph:new-chat` (при условии, что 'store_unknown_chats_in_db' => false в `telegraph.php`, иначе все чаты, в которые будут добавлять бота, будут автоматически сохраняться в бд);
6. Введите ID чата (можно получить через `/chatid`), затем имя бота.
После проведенных действий, запускаем скрипт для вебхука `setup-webhook.sh` через докер контейнер tg-bot-webhook-setup или командой: `php artisan telegraph:set-webhook`.
## Добавление задачи в планировщик:
1. Используйте Windows Task Scheduler или Cron, в зависимости от системы;
2. Необходимо выполнять команду `docker exec -it tg-bot-app php artisan schedule:check-reports`;
3. Триггер - ежедневно, выполнять задачу раз в минуту.
